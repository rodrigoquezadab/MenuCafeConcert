<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pedido Caf√© Concert</title>

<!-- Dependencias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg: #eef2f5;
    --card: #ffffff;
    --accent: #2c3e50;
    --green: #27ae60;
    --muted: #777;
  }

  /* Global */
  body{
    margin:0;
    padding:14px;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #222;
  }

  h1{ text-align:center; margin:0 0 12px 0; color:var(--accent); font-size:1.4rem; }

  /* Layout */
  .container{
    max-width: 920px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 16px;
    align-items: start;
  }

  @media (max-width:880px){
    .container{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--card);
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }

  /* Compact single-line items */
  .row-item{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 4px;
    border-bottom:1px dashed #f1f1f1;
    min-height:36px;
  }
  .row-item:last-child{ border-bottom:none; }

  .row-item label{
    flex:1 1 auto;
    font-size:0.95rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-right:8px;
  }

  .row-item .price{ flex:0 0 90px; text-align:right; color:var(--green); font-weight:600; white-space:nowrap; }

  .row-item input.qty{
    flex: 0 0 64px;
    width:64px;
    padding:6px;
    font-size:0.95rem;
    text-align:center;
    border-radius:6px;
    border:1px solid #ccc;
    background:#fff;
  }

  /* Controls/summary */
  .controls{ display:flex; flex-direction:column; gap:8px; }
  .controls .input-block input{ width:100%; padding:8px; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; }

  .total-display{ text-align:right; font-weight:700; color:#1f618d; font-size:1.05rem; }
  .vuelto{ text-align:right; font-weight:700; color:var(--green); font-size:0.98rem; }

  .btn{ width:100%; padding:12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; }
  .btn-primary{ background:#3498db; color:#fff; }
  .btn-success{ background:var(--green); color:#fff; }

  /* Receipt preview (on-screen) */
  #receipt-preview{
    background:var(--card);
    width:300px;            /* visible width on screen */
    padding:14px;
    border-radius:8px;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    display:none;
    color:#000;
    font-family: Arial, Helvetica, sans-serif;
    border:1px solid #e2e2e2;
  }

  .ticket-header{ text-align:center; margin-bottom:8px; }
  .ticket-header h3{ margin:0; font-size:18px; color:var(--accent); }
  .ticket-meta{ font-size:12px; color:#666; margin-top:6px; text-align:left; }

  .ticket-table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:6px; }
  .ticket-table td{ padding:4px 0; vertical-align:middle; }
  .ticket-table .desc{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; } /* single-line */
  .ticket-table .amount{ text-align:right; width:110px; white-space:nowrap; }

  .ticket-total{ border-top:2px solid #000; margin-top:8px; padding-top:8px; font-weight:700; display:flex; justify-content:space-between; font-size:15px; }
  .ticket-footer{ text-align:center; color:#777; font-size:12px; margin-top:12px; }

  /* Small helper */
  .small-note{ font-size:0.85rem; color:var(--muted); margin:0; }

</style>
</head>
<body>

<h1>‚òï Caf√© Concert - Sistema de Pedidos üçΩÔ∏è</h1>

<div class="container">

  <!-- LEFT: form -->
  <div class="card">
    <h2 style="margin:0 0 10px 0;">1. Selecciona Productos</h2>

    <!-- Individuales -->
    <div style="margin-bottom:10px;">
      <h3 style="margin:0 0 8px 0; font-size:1rem;">√çtems Individuales</h3>
      <div id="list-individual"></div>
    </div>

    <!-- Combos -->
    <div style="margin-bottom:8px;">
      <h3 style="margin:0 0 8px 0; font-size:1rem;">Combos</h3>
      <div id="list-combos"></div>
    </div>

    <!-- Controls / totals -->
    <div class="controls" style="margin-top:12px;">
      <div>
        <label class="small-note">Cliente</label>
        <input id="clientName" type="text" placeholder="Nombre (Opcional)" />
      </div>
      <div>
        <label class="small-note">Dinero recibido</label>
        <input id="received" type="number" placeholder="0" />
      </div>

      <div>
        <div class="total-display" id="live-total">Total: $0</div>
        <div class="vuelto" id="live-vuelto">Vuelto: $0</div>
      </div>

      <button id="btn-preview" class="btn btn-primary">üëÅÔ∏è Ver Comprobante</button>
    </div>
  </div>

  <!-- RIGHT: preview & download -->
  <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
    <p id="preview-placeholder" class="small-note">La boleta aparecer√° aqu√≠ despu√©s de generar la vista previa.</p>

    <div id="receipt-preview" aria-hidden="true"></div>

    <button id="btn-download" class="btn btn-success" style="display:none; width:300px;">üì• Descargar PDF (100 √ó 400 mm)</button>
  </div>

</div>

<script>
/* --------------------------
   Datos (productos y combos)
---------------------------*/
const products = {
  // Individuales
  i1: { name: 'S√°ndwich Gourmet ü•êüçó', price: 5000 },
  i2: { name: 'Empanada Jam√≥n y Queso ü•üüßÄ', price: 4500 },
  i3: { name: 'Aliado Tradicional üçûüßÄ', price: 3000 },
  i4: { name: 'Copa de Vino üç∑', price: 3000 },
  i5: { name: 'Vaso de Cerveza üç∫', price: 2500 },
  i6: { name: 'Vaso Bebida ü•§', price: 2000 },
  i7: { name: 'T√© o Caf√© ‚òï', price: 2000 },

  // Combos
  c1: { name: 'Combo S√°ndwich + Vino ü•™+üç∑', price: 7500 },
  c2: { name: 'Combo S√°ndwich + Cerveza ü•™+üç∫', price: 7000 },
  c3: { name: 'Combo Empanada + Vino ü•ü+üç∑', price: 7000 },
  c4: { name: 'Combo Empanada + Cerveza ü•ü+üç∫', price: 6500 }
};

/* --------------------------
   Render inputs
---------------------------*/
const listInd = document.getElementById('list-individual');
const listComb = document.getElementById('list-combos');

function createRow(id, item, container){
  const d = document.createElement('div');
  d.className = 'row-item';
  d.innerHTML = `
    <label title="${escapeHtml(item.name)}">${escapeHtml(item.name)} <span style="color:#999; font-weight:600;">($${item.price.toLocaleString('es-CL')})</span></label>
    <span class="price">$${item.price.toLocaleString('es-CL')}</span>
    <input type="number" class="qty" data-id="${id}" data-price="${item.price}" min="0" placeholder="0" />
  `;
  container.appendChild(d);
}

Object.entries(products).forEach(([k,v])=>{
  if(k.startsWith('i')) createRow(k,v,listInd);
  else createRow(k,v,listComb);
});

/* --------------------------
   Calculation & live UI
---------------------------*/
function calculate(){
  let total = 0;
  const items = [];
  document.querySelectorAll('input.qty').forEach(inp=>{
    const q = parseInt(inp.value) || 0;
    if(q > 0){
      const price = parseInt(inp.dataset.price);
      const subtotal = q * price;
      total += subtotal;
      // get name text from label
      const label = inp.parentElement.querySelector('label');
      const name = label ? label.innerText.split('($')[0].trim() : inp.dataset.id;
      items.push({ name, qty: q, subtotal });
    }
  });
  const received = parseInt(document.getElementById('received').value) || 0;
  const vuelto = received - total;
  const client = document.getElementById('clientName').value || 'Cliente General';
  return { total, items, received, vuelto, client };
}

function updateLiveUI(){
  const d = calculate();
  document.getElementById('live-total').innerText = `Total: $${d.total.toLocaleString('es-CL')}`;
  const vEl = document.getElementById('live-vuelto');
  if(document.getElementById('received').value !== ''){
    if(d.vuelto >= 0){
      vEl.innerText = `Vuelto: $${d.vuelto.toLocaleString('es-CL')}`;
      vEl.style.color = '#27ae60';
    } else {
      vEl.innerText = `Falta: $${Math.abs(d.vuelto).toLocaleString('es-CL')}`;
      vEl.style.color = '#c0392b';
    }
  } else {
    vEl.innerText = 'Vuelto: $0';
    vEl.style.color = '#27ae60';
  }
}

document.querySelectorAll('input').forEach(i=> i.addEventListener('input', updateLiveUI));

/* --------------------------
   Build preview HTML
---------------------------*/
document.getElementById('btn-preview').addEventListener('click', ()=>{
  const data = calculate();
  if(data.items.length === 0) return alert('Selecciona al menos un producto.');

  const now = new Date();
  const fecha = now.toLocaleDateString('es-CL');
  const hora = now.toLocaleTimeString('es-CL');

  const rows = data.items.map(it=>`
    <tr>
      <td class="desc" style="padding-right:8px;">${escapeHtml(it.qty + ' x ' + it.name)}</td>
      <td class="amount">$${it.subtotal.toLocaleString('es-CL')}</td>
    </tr>
  `).join('');

  const previewHtml = `
    <div class="ticket-header">
      <h3>CAF√â CONCERT ‚òïüçΩÔ∏è</h3>
      <div class="ticket-meta">
        <div style="font-weight:600;">COMPROBANTE DE PEDIDO</div>
        <div>Fecha: ${fecha} - ${hora}</div>
        <div>Cliente: ${escapeHtml(data.client)}</div>
      </div>
    </div>

    <table class="ticket-table" role="presentation">
      <tbody>${rows}</tbody>
    </table>

    <div class="ticket-total">
      <div>TOTAL</div>
      <div>$${data.total.toLocaleString('es-CL')}</div>
    </div>

    ${data.received > 0 ? `
      <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:13px;">
        <div>Efectivo:</div><div>$${data.received.toLocaleString('es-CL')}</div>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:2px; font-size:13px;">
        <div>Vuelto:</div><div style="color:${data.vuelto>=0? '#27ae60' : '#c0392b'}">$${data.vuelto.toLocaleString('es-CL')}</div>
      </div>
    ` : ''}

    <div class="ticket-footer">*** Gracias por su preferencia ***</div>
  `;

  const preview = document.getElementById('receipt-preview');
  preview.innerHTML = previewHtml;
  preview.style.display = 'block';
  preview.setAttribute('aria-hidden','false');
  document.getElementById('preview-placeholder').style.display = 'none';
  document.getElementById('btn-download').style.display = 'inline-block';
});

/* --------------------------
   Download PDF (100 x 400 mm)
---------------------------*/
document.getElementById('btn-download').addEventListener('click', async ()=>{
  const preview = document.getElementById('receipt-preview');
  const btn = document.getElementById('btn-download');
  btn.disabled = true;
  const oldText = btn.innerText;
  btn.innerText = 'Generando PDF...';

  try{
    // ensure visible and white background
    preview.style.display = 'block';
    preview.style.background = '#ffffff';
    // expand visible width so html2canvas uses that layout
    preview.style.width = '100mm';
    preview.style.maxWidth = '100mm';

    // small delay for styles to apply
    await new Promise(r => setTimeout(r, 120));

    // render canvas
    const canvas = await html2canvas(preview, {
      scale: 3,
      backgroundColor: '#ffffff',
      useCORS: true
    });

    const imgData = canvas.toDataURL('image/png');

    // compute height in mm proportionally
    const pdfWidthMm = 100; // requested width
    const imgWidthPx = canvas.width;
    const imgHeightPx = canvas.height;
    const imgHeightMm = (imgHeightPx * pdfWidthMm) / imgWidthPx;

    // set target PDF height = 400 mm (as you requested), but if content shorter, use content height
    const pdfHeightMm = Math.max(400, Math.ceil(imgHeightMm));

    // create jsPDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      unit: 'mm',
      format: [pdfWidthMm, pdfHeightMm],
      orientation: 'portrait'
    });

    // add image at full width, centered horizontally at 0
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidthMm, imgHeightMm);

    // If content shorter than 400mm, it's fine (image sits at top). If taller, image will be clipped;
    // For long content we could split into pages, but you requested a 400mm tall document specifically.

    pdf.save(`Pedido_${Date.now()}.pdf`);

  } catch (err){
    console.error(err);
    alert('Ocurri√≥ un error generando el PDF.');
  } finally {
    // restore preview size for screen
    preview.style.width = '300px';
    preview.style.maxWidth = '300px';
    btn.disabled = false;
    btn.innerText = oldText || 'üì• Descargar PDF (100 √ó 400 mm)';
  }
});

/* --------------------------
   Helpers
---------------------------*/
function escapeHtml(text){
  if(!text) return '';
  return String(text).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'
  })[s]);
}
</script>

</body>
</html>
