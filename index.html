<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Pedido Caf√© Concert</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  /* ESTILOS DE LA APLICACI√ìN */
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #e9ecef; padding: 20px; margin: 0; color: #333; }
  .container { max-width: 800px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 20px; }
  
  /* Columna Izquierda: Formulario */
  .form-section { flex: 1; min-width: 300px; }
  /* Columna Derecha: Previsualizaci√≥n */
  .preview-section { flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; }

  .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
  h1 { text-align: center; color: #2c3e50; margin-top: 0; }
  h2 { font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; }

  .row-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #f1f1f1; padding-bottom: 5px; }
  .row-item label { font-size: 0.9rem; flex: 1; }
  .row-item input { width: 50px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }

  .total-display { font-size: 1.2rem; font-weight: bold; text-align: right; color: #007bff; margin-top: 10px; }

  .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; margin-top: 10px; }
  .btn-primary { background: #007bff; color: white; }
  .btn-primary:hover { background: #0056b3; }
  .btn-success { background: #28a745; color: white; }
  .btn-success:hover { background: #218838; }

  /* ESTILOS DE LA BOLETA (VISTA PREVIA) */
  #receipt-preview {
    background: #fff;
    width: 300px; /* Ancho fijo tipo boleta */
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    margin-bottom: 20px;
    display: none; /* Oculto hasta generar */
    font-family: 'Courier New', Courier, monospace; /* Fuente tipo ticket */
    color: #000;
    border: 1px solid #ddd;
  }

  /* Estilos internos del ticket para asegurar impresi√≥n */
  .ticket-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
  .ticket-body { margin-bottom: 15px; font-size: 13px; }
  .ticket-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
  .ticket-total { border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; font-weight: bold; font-size: 14px; }
  .ticket-footer { text-align: center; margin-top: 20px; font-size: 11px; color: #444; }

</style>
</head>
<body>

<h1>‚òï Caf√© Concert - Sistema de Pedidos üçΩÔ∏è</h1>

<div class="container">
  
  <!-- SECCI√ìN DE INGRESO DE DATOS -->
  <div class="form-section">
    
    <div class="card">
      <h2>1. √çtems Individuales</h2>
      <div id="list-individual"></div>
    </div>

    <div class="card">
      <h2>2. Combos</h2>
      <div id="list-combos"></div>
    </div>

    <div class="card">
      <h2>3. Datos y Totales</h2>
      <div style="margin-bottom: 10px;">
        <label style="display:block; font-size:0.9rem;">Cliente:</label>
        <input type="text" id="clientName" style="width:100%; padding:8px; box-sizing:border-box;" placeholder="Nombre (Opcional)">
      </div>
      <div style="margin-bottom: 10px;">
        <label style="display:block; font-size:0.9rem;">Dinero Recibido:</label>
        <input type="number" id="received" style="width:100%; padding:8px; box-sizing:border-box;" placeholder="0">
      </div>
      
      <div id="live-total" class="total-display">Total: $0</div>
      <div id="live-vuelto" style="text-align:right; font-weight:bold; color:#28a745;">Vuelto: $0</div>

      <button class="btn btn-primary" id="btn-preview">üëÅÔ∏è Generar Vista Previa</button>
    </div>

  </div>

  <!-- SECCI√ìN DE VISTA PREVIA -->
  <div class="preview-section">
    <div id="preview-placeholder" style="color:#777; margin-top:50px;">
      <em>La boleta aparecer√° aqu√≠...</em>
    </div>

    <!-- AQU√ç SE PINTAR√Å LA BOLETA -->
    <div id="receipt-preview">
      <!-- Contenido din√°mico -->
    </div>

    <!-- BOT√ìN DE DESCARGA (Oculto inicialmente) -->
    <button class="btn btn-success" id="btn-download" style="display:none; max-width: 300px;">
      üì• Descargar PDF Ahora
    </button>
  </div>

</div>

<script>
  // --- 1. CONFIGURACI√ìN ---
  const products = {
    // Individuales
    i1: { name: 'S√°ndwich Gourmet', price: 5000 },
    i2: { name: 'Empanada J/Q', price: 4500 },
    i3: { name: 'Aliado Tradicional', price: 3000 },
    i4: { name: 'Copa Vino', price: 3000 },
    i5: { name: 'Vaso Cerveza', price: 2500 },
    i6: { name: 'Vaso Bebida', price: 2000 },
    i7: { name: 'T√© o Caf√©', price: 2000 },
    // Combos
    c1: { name: 'Combo S√°ndwich+Vino', price: 7500 },
    c2: { name: 'Combo S√°ndwich+Cerveza', price: 7000 },
    c3: { name: 'Combo S√°ndwich+Bebida', price: 6500 },
    c4: { name: 'Combo Empanada+Vino', price: 7000 },
    c5: { name: 'Combo Empanada+Cerveza', price: 6500 }
  };

  // --- 2. GENERAR INPUTS ---
  const divInd = document.getElementById('list-individual');
  const divCom = document.getElementById('list-combos');

  function createInput(id, item, container) {
    const div = document.createElement('div');
    div.className = 'row-item';
    div.innerHTML = `
      <label>${item.name} ($${item.price})</label>
      <input type="number" min="0" class="qty-input" data-id="${id}" placeholder="0">
    `;
    container.appendChild(div);
  }

  Object.entries(products).forEach(([k, v]) => {
    if(k.startsWith('i')) createInput(k, v, divInd);
    else createInput(k, v, divCom);
  });

  // --- 3. C√ÅLCULOS EN VIVO ---
  function calculate() {
    let total = 0;
    let items = [];
    document.querySelectorAll('.qty-input').forEach(inp => {
      const val = parseInt(inp.value) || 0;
      if(val > 0) {
        const prod = products[inp.dataset.id];
        const subtotal = val * prod.price;
        total += subtotal;
        items.push({ ...prod, qty: val, subtotal });
      }
    });
    
    const received = parseInt(document.getElementById('received').value) || 0;
    const vuelto = received - total;
    const client = document.getElementById('clientName').value || 'Cliente General';

    return { total, items, received, vuelto, client };
  }

  function updateLiveUI() {
    const data = calculate();
    document.getElementById('live-total').innerText = `Total: $${data.total.toLocaleString('es-CL')}`;
    const vEl = document.getElementById('live-vuelto');
    
    if(data.received > 0) {
      vEl.innerText = data.vuelto >= 0 
        ? `Vuelto: $${data.vuelto.toLocaleString('es-CL')}` 
        : `Falta: $${Math.abs(data.vuelto).toLocaleString('es-CL')}`;
      vEl.style.color = data.vuelto >= 0 ? '#28a745' : '#dc3545';
    } else {
      vEl.innerText = "Vuelto: $0";
      vEl.style.color = "#28a745";
    }
  }

  document.querySelectorAll('input').forEach(i => i.addEventListener('input', updateLiveUI));

  // --- 4. GENERAR VISTA PREVIA (PASO CLAVE) ---
  document.getElementById('btn-preview').addEventListener('click', () => {
    const data = calculate();
    if(data.items.length === 0) return alert("Selecciona productos primero.");

    const now = new Date();
    const fecha = now.toLocaleDateString('es-CL');
    const hora = now.toLocaleTimeString('es-CL');

    // Construimos el HTML INTERNO de la boleta
    // Usamos <table> para garantizar alineaci√≥n en el PDF
    let itemsHtml = data.items.map(i => `
      <tr>
        <td style="padding:2px 0;">${i.qty} x ${i.name}</td>
        <td style="text-align:right;">$${i.subtotal.toLocaleString('es-CL')}</td>
      </tr>
    `).join('');

    const receiptHtml = `
      <div class="ticket-header">
        <h3 style="margin:0; font-size:18px;">CAF√â CONCERT</h3>
        <p style="margin:2px 0 10px 0; font-size:12px;">COMPROBANTE DE PEDIDO</p>
        <div style="font-size:12px; text-align:left;">
          <p style="margin:2px 0;">FECHA: ${fecha} ${hora}</p>
          <p style="margin:2px 0;">CLIENTE: ${data.client}</p>
        </div>
      </div>

      <table style="width:100%; font-size:12px; border-collapse:collapse;">
        <tbody>${itemsHtml}</tbody>
      </table>

      <div class="ticket-total">
        <div style="display:flex; justify-content:space-between;">
          <span>TOTAL:</span>
          <span>$${data.total.toLocaleString('es-CL')}</span>
        </div>
        ${data.received > 0 ? `
        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:normal; margin-top:5px;">
          <span>Efectivo:</span>
          <span>$${data.received.toLocaleString('es-CL')}</span>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:normal;">
          <span>Vuelto:</span>
          <span>$${data.vuelto.toLocaleString('es-CL')}</span>
        </div>
        ` : ''}
      </div>

      <div class="ticket-footer">
        <p>*** Gracias por su preferencia ***</p>
      </div>
    `;

    // Inyectar al DOM visible
    const previewDiv = document.getElementById('receipt-preview');
    previewDiv.innerHTML = receiptHtml;
    
    // Mostrar elementos
    document.getElementById('preview-placeholder').style.display = 'none';
    previewDiv.style.display = 'block';
    document.getElementById('btn-download').style.display = 'block';
  });

  // --- 5. DESCARGAR LO QUE YA VEMOS ---
  document.getElementById('btn-download').addEventListener('click', async () => {
    const element = document.getElementById('receipt-preview');
    const btn = document.getElementById('btn-download');
    
    btn.innerText = "Generando...";
    btn.disabled = true;

    const opt = {
      margin:       0,
      filename:     `Pedido_${Date.now()}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { 
        scale: 2, 
        useCORS: true,
        logging: false
      },
      jsPDF:        { unit: 'mm', format: [80, 200], orientation: 'portrait' }
    };

    try {
      await html2pdf().set(opt).from(element).save();
    } catch (err) {
      console.error(err);
      alert("Error al descargar");
    } finally {
      btn.innerText = "üì• Descargar PDF Ahora";
      btn.disabled = false;
    }
  });

</script>
</body>
</html>