<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<!-- Viewport para asegurar que se vea bien en m√≥viles -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pedido Caf√© Concert</title>

<!-- USAMOS LAS LIBRER√çAS CL√ÅSICAS QUE SON M√ÅS ESTABLES PARA ESTO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* --- 1. ESTILOS BASE (MOBILE FIRST) --- */
  * {
    box-sizing: border-box; /* Previene que el padding rompa el ancho */
  }

  body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: #f4f4f9;
    margin: 0;
    padding: 10px;
    color: #333;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 50px;
  }

  h1 {
    text-align: center;
    color: #2c3e50;
    font-size: 1.5rem;
    margin: 10px 0 20px 0;
  }

  /* --- 2. TARJETAS --- */
  .card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  h2 {
    font-size: 1.1rem;
    margin: 0 0 10px 0;
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
    color: #e67e22;
    line-height: 1.4;
  }

  /* --- 3. LISTA DE PRODUCTOS --- */
  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-bottom: 10px;
    border-bottom: 1px dashed #eee;
  }
  .item-row:last-child { border-bottom: none; margin-bottom: 0; }

  .item-info { flex: 1; padding-right: 10px; }
  
  .item-name {
    font-weight: 600;
    font-size: 0.9rem;
    display: block;
    color: #2c3e50;
  }
  
  .item-price { color: #27ae60; font-weight: bold; font-size: 0.9rem; }
  .item-desc { font-size: 0.75rem; color: #777; display: block; margin-top: 2px; font-style: italic; }

  /* Inputs t√°ctiles */
  input[type="number"].qty {
    width: 60px;
    height: 40px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1.1rem;
    background: #f9f9f9;
  }

  /* --- 4. PAGOS Y TOTALES --- */
  .form-group { margin-bottom: 10px; }
  .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
  .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }

  .total-display { text-align: right; font-size: 1.4rem; font-weight: bold; color: #2980b9; margin-top: 10px; }
  #vuelto-display { text-align: right; font-weight: bold; color: #27ae60; margin-bottom: 10px; }

  button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 5px;
    transition: 0.2s;
  }
  .btn-preview { background: #3498db; color: white; }
  .btn-download { background: #27ae60; color: white; margin-top: 15px; }
  
  /* --- 5. VISTA PREVIA (ESTILO RESPONSIVE PERO IMPRIMIBLE) --- */
  #preview-area {
    display: none;
    margin-top: 20px;
    background: #e9ecef;
    padding: 15px;
    border-radius: 10px;
  }

  /* El recibo visual */
  #receipt-visual {
    background: white;
    padding: 20px;
    /* Ancho fluido para m√≥vil, pero suficiente info para PDF */
    width: 100%; 
    margin: 0 auto;
    color: #000;
    font-family: Arial, sans-serif;
    border-radius: 5px;
  }

  /* Tabla simple que funciona bien en m√≥vil y papel */
  .visual-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  .visual-table th { text-align: left; border-bottom: 2px solid #333; padding: 5px 0; }
  .visual-table td { border-bottom: 1px solid #eee; padding: 8px 0; vertical-align: top; }
  .text-right { text-align: right; }
  
  /* Evitar quiebre de palabras en precios */
  .no-wrap { white-space: nowrap; }

</style>
</head>
<body>

<div class="container">
  <h1>Caf√© Concert ‚òïüçΩÔ∏è</h1>

  <!-- Contenedor del Men√∫ -->
  <div id="menu-container"></div>

  <!-- Contenedor Pago -->
  <div class="card">
    <h2>Pago üíµ</h2>
    
    <div class="form-group">
      <label>Cliente (Opcional):</label>
      <input type="text" id="clientName">
    </div>
    
    <div class="form-group">
      <label>Dinero Recibido ($):</label>
      <input type="tel" id="received" placeholder="0">
    </div>

    <div class="total-display" id="total-text">Total: $0</div>
    <div id="vuelto-display">Vuelto: $0</div>

    <button class="btn-preview" id="btn-preview">üëÅÔ∏è Ver Comprobante</button>
  </div>

  <!-- Vista Previa -->
  <div id="preview-area">
    <p style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:10px;">Vista previa del documento:</p>
    
    <!-- ESTO ES LO QUE SE IMPRIMIR√Å -->
    <div id="receipt-visual">
      <!-- Se llena con JS -->
    </div>

    <button class="btn-download" id="btn-download">üì• Descargar PDF (A4)</button>
  </div>
</div>

<script>
  // --- 1. DATOS ACTUALIZADOS SEG√öN REQUERIMIENTO ---
  const menuData = [
    {
      title: "Para Comer üçîü•™",
      items: [
        { 
          name: 'S√°ndwich Gourmet', 
          price: 5000, 
          desc: 'Pan hojaldre ü•ê, pollo üçó, tomate üçÖ, palta ü•ë, cebolla caramelizada üßÖ y lacto mayo' 
        },
        { 
          name: 'Empanada Horno Jam√≥n y Queso Gourmet', 
          price: 4500, 
          desc: 'Jam√≥n ü•ì y queso üßÄ en masa de horno ü•ü' 
        },
        { 
          name: 'Aliado Jam√≥n y Queso Tradicional', 
          price: 3000, 
          desc: 'Jam√≥n ü•ì y queso üßÄ en pan de molde üçû con base de mayonesa' 
        }
      ]
    },
    {
      title: "Para Beber üç∑üç∫ü•§‚òïü•õ",
      items: [
        { name: 'Vino (copa) üç∑', price: 3000 },
        { name: 'Cerveza (vaso) üç∫', price: 2500 },
        { name: 'Bebida (vaso) ü•§', price: 2000 },
        { name: 'T√© o Caf√© ‚òï', price: 2000 },
        { name: 'Agua (vaso) ü•õ', price: 1500 }
      ]
    },
    {
      title: "Combos S√°ndwich Gourmet ü•™üç∑ <br><span style='font-size:0.85em; font-weight:normal; color:#555;'>(S√°ndwich solo: $5.000)</span>",
      items: [
        { name: 'S√°ndwich + Copa de Vino üç∑', price: 7500 },
        { name: 'S√°ndwich + Cerveza üç∫', price: 7000 },
        { name: 'S√°ndwich + Bebida ü•§', price: 6500 },
        { name: 'S√°ndwich + T√© o Caf√© ‚òï', price: 6500 },
        { name: 'S√°ndwich + Agua ü•õ', price: 6000 }
      ]
    },
    {
      title: "Combos Empanada Horno Jam√≥n y Queso Gourmet ü•üüç∑ <br><span style='font-size:0.85em; font-weight:normal; color:#555;'>(Empanada sola: $4.500)</span>",
      items: [
        { name: 'Empanada + Copa de Vino üç∑', price: 7000 },
        { name: 'Empanada + Cerveza üç∫', price: 6500 },
        { name: 'Empanada + Bebida ü•§', price: 6000 },
        { name: 'Empanada + T√© o Caf√© ‚òï', price: 6000 },
        { name: 'Empanada + Agua ü•õ', price: 5500 }
      ]
    },
    {
      title: "Combos Aliado Jam√≥n y Queso Tradicional ü•™üç∑ <br><span style='font-size:0.85em; font-weight:normal; color:#555;'>(Aliado solo: $3.000)</span>",
      items: [
        { name: 'Aliado + Copa de Vino üç∑', price: 5500 },
        { name: 'Aliado + Cerveza üç∫', price: 5000 },
        { name: 'Aliado + Bebida ü•§', price: 4500 },
        { name: 'Aliado + T√© o Caf√© ‚òï', price: 4500 },
        { name: 'Aliado + Agua ü•õ', price: 4000 }
      ]
    }
  ];

  // --- 2. GENERAR HTML DE PRODUCTOS ---
  const container = document.getElementById('menu-container');

  menuData.forEach(section => {
    const card = document.createElement('div');
    card.className = 'card';
    let html = `<h2>${section.title}</h2>`;
    
    section.items.forEach(item => {
      // Input con min="0" para evitar negativos desde HTML
      html += `
        <div class="item-row">
          <div class="item-info">
            <span class="item-name">${item.name}</span>
            <span class="item-price">$${item.price.toLocaleString('es-CL')}</span>
            ${item.desc ? `<span class="item-desc">${item.desc}</span>` : ''}
          </div>
          <input type="number" class="qty" 
            data-name="${item.name}" 
            data-price="${item.price}" 
            min="0"
            placeholder="0" inputmode="numeric">
        </div>
      `;
    });
    card.innerHTML = html;
    container.appendChild(card);
  });

  // --- 3. C√ÅLCULOS ---
  function calculate() {
    let total = 0;
    let items = [];
    
    document.querySelectorAll('.qty').forEach(input => {
      let val = input.value;
      if(val && val > 0) {
        const qty = parseInt(val);
        const price = parseInt(input.dataset.price);
        const subtotal = qty * price;
        total += subtotal;
        items.push({ name: input.dataset.name, qty, price, subtotal });
      }
    });

    const receivedVal = document.getElementById('received').value;
    const received = receivedVal ? parseInt(receivedVal) : 0;
    const vuelto = received - total;
    const client = document.getElementById('clientName').value || 'Cliente General';

    return { total, items, received, vuelto, client };
  }

  function updateUI() {
    const data = calculate();
    document.getElementById('total-text').innerText = `Total: $${data.total.toLocaleString('es-CL')}`;
    
    const vEl = document.getElementById('vuelto-display');
    if(document.getElementById('received').value !== '') {
      vEl.innerText = data.vuelto >= 0 
        ? `Vuelto: $${data.vuelto.toLocaleString('es-CL')}`
        : `Falta: $${Math.abs(data.vuelto).toLocaleString('es-CL')}`;
      vEl.style.color = data.vuelto >= 0 ? '#27ae60' : '#c0392b';
    } else {
      vEl.innerText = 'Vuelto: $0';
      vEl.style.color = '#27ae60';
    }
  }

  // Validaci√≥n en tiempo real para evitar negativos
  document.addEventListener('input', (e) => {
    
    if(e.target.matches('.qty')) {
      // Si el valor es negativo, lo ponemos en 0
      if(e.target.value < 0) {
        e.target.value = 0;
      }
      updateUI();
    }
    
    if(e.target.id === 'received') {
      // Evitar dinero recibido negativo tambi√©n
      if(e.target.value < 0) {
        e.target.value = 0;
      }
      updateUI();
    }
  });

  // --- 4. BOT√ìN VISTA PREVIA ---
  document.getElementById('btn-preview').addEventListener('click', () => {
    const data = calculate();
    if(data.items.length === 0) return alert("Selecciona productos primero.");

    const now = new Date();
    
    // Construimos la tabla
    const rows = data.items.map(item => `
      <tr>
        <td><b>${item.qty}</b> x ${item.name}</td>
        <td class="text-right no-wrap">$${item.subtotal.toLocaleString('es-CL')}</td>
      </tr>
    `).join('');

    // HTML limpio y responsivo (ancho 100%)
    const html = `
      <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:15px;">
        <h2 style="margin:0; font-size:1.4rem; color:#2c3e50;">Caf√© Concert ‚òï</h2>
        <p style="margin:5px 0 0 0; color:#666; font-size:0.9rem;">COMPROBANTE</p>
        <p style="margin:0; font-size:0.8rem;">${now.toLocaleDateString('es-CL')} ${now.toLocaleTimeString('es-CL').slice(0,5)}</p>
      </div>

      <div style="margin-bottom:15px; font-size:0.95rem;">
        <strong>Cliente:</strong> ${data.client}
      </div>

      <table class="visual-table">
        <thead>
          <tr>
            <th style="width:70%">Descripci√≥n</th>
            <th class="text-right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>

      <div style="margin-top:20px; text-align:right;">
        <div style="font-size:1.3rem; font-weight:bold;">Total: $${data.total.toLocaleString('es-CL')}</div>
        ${data.received > 0 ? `<div style="font-size:0.9rem; margin-top:5px;">Efectivo: $${data.received.toLocaleString('es-CL')}</div>` : ''}
        ${data.received > 0 ? `<div style="font-weight:bold; color:${data.vuelto>=0?'green':'red'}">Vuelto: $${data.vuelto.toLocaleString('es-CL')}</div>` : ''}
      </div>
      
      <div style="text-align:center; margin-top:30px; font-size:0.8rem; color:#888;">
        Gracias por su preferencia
      </div>
    `;

    const previewDiv = document.getElementById('receipt-visual');
    previewDiv.innerHTML = html;
    
    // Mostrar
    document.getElementById('preview-area').style.display = 'block';
    document.getElementById('preview-area').scrollIntoView({ behavior: 'smooth' });
  });

  // --- 5. BOT√ìN DESCARGA PDF (M√âTODO SEGURO) ---
  document.getElementById('btn-download').addEventListener('click', async () => {
    const element = document.getElementById('receipt-visual');
    const btn = document.getElementById('btn-download');
    
    btn.innerText = "Generando...";
    btn.disabled = true;

    try {
      // 1. CAPTURAR LA IMAGEN DE LO QUE SE VE
      // Scale 2 mejora la calidad de texto
      const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
      const imgData = canvas.toDataURL("image/png");

      // 2. CALCULAR DIMENSIONES PARA AJUSTAR AL A4
      // A4 es 210mm de ancho. Dejamos m√°rgenes (ej. 10mm por lado) => 190mm disponibles
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      const pdfWidth = pdf.internal.pageSize.getWidth();   // 210
      const pdfHeight = pdf.internal.pageSize.getHeight(); // 297
      
      const margin = 10; 
      const contentWidth = pdfWidth - (margin * 2); // 190mm
      
      // Regla de tres para calcular el alto proporcional
      const imgProps = pdf.getImageProperties(imgData);
      const contentHeight = (imgProps.height * contentWidth) / imgProps.width;

      // 3. AGREGAR IMAGEN AL PDF
      pdf.addImage(imgData, 'PNG', margin, margin, contentWidth, contentHeight);

      // 4. GUARDAR
      pdf.save(`Pedido_${Date.now()}.pdf`);

    } catch (err) {
      console.error(err);
      alert("Error al generar PDF");
    } finally {
      btn.innerText = "üì• Descargar PDF (A4)";
      btn.disabled = false;
    }
  });

</script>

</body>
</html>