<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Pedido Caf√© Concert</title>
<!-- Usamos la versi√≥n m√°s compatible de html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  /* ESTILOS DE LA APP (No afectan al PDF) */
  body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; max-width: 600px; margin: 0 auto; }
  .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  h1 { text-align: center; color: #333; font-size: 1.5rem; }
  h2 { font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; }
  
  .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f9f9f9; }
  label { font-size: 0.9rem; font-weight: bold; color: #444; flex: 1; }
  input.qty { width: 50px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
  
  .total-box { font-size: 1.3rem; font-weight: bold; text-align: right; color: #007bff; }
  .input-group { margin-bottom: 10px; }
  .input-group label { display: block; margin-bottom: 5px; }
  .input-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
  
  button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; }
  button:disabled { background: #ccc; }
</style>
</head>
<body>

<h1>‚òï Caf√© Concert üçΩÔ∏è</h1>

<div class="card">
  <h2>√çtems Individuales</h2>
  <div id="list-items"></div>
</div>

<div class="card">
  <h2>Combos</h2>
  <div id="list-combos"></div>
</div>

<div class="card">
  <h2>Resumen</h2>
  <div id="preview-text" style="color:#666; font-size:0.9rem; margin-bottom:10px;">Sin √≠tems...</div>
  <div id="display-total" class="total-box">Total: $0</div>
</div>

<div class="card">
  <h2>Pago</h2>
  <div class="input-group">
    <label>Nombre Cliente:</label>
    <input type="text" id="clientName" placeholder="Opcional">
  </div>
  <div class="input-group">
    <label>Dinero Recibido:</label>
    <input type="number" id="received" placeholder="0">
  </div>
  <div id="display-vuelto" style="text-align: right; font-weight: bold; font-size: 1.1rem; color: #28a745;">Vuelto: $0</div>
  <br>
  <button id="btn-print">üìÑ DESCARGAR PDF</button>
</div>

<!-- CONTENEDOR OCULTO PARA EL PDF (Se llenar√° din√°micamente) -->
<div id="pdf-container"></div>

<script>
  // 1. DATOS
  const products = {
    // Individuales
    i1: {name: 'S√°ndwich Gourmet', price: 5000},
    i2: {name: 'Empanada J/Q', price: 4500},
    i3: {name: 'Aliado Tradicional', price: 3000},
    i4: {name: 'Copa Vino', price: 3000},
    i5: {name: 'Vaso Cerveza', price: 2500},
    i6: {name: 'Vaso Bebida', price: 2000},
    i7: {name: 'Vaso Agua', price: 1500},
    i8: {name: 'T√© o Caf√©', price: 2000},
    // Combos
    c1: {name: 'Combo S√°ndwich+Vino', price: 7500},
    c2: {name: 'Combo S√°ndwich+Cerveza', price: 7000},
    c3: {name: 'Combo S√°ndwich+Bebida', price: 6500},
    c4: {name: 'Combo Empanada+Vino', price: 7000},
    c5: {name: 'Combo Empanada+Cerveza', price: 6500},
    c6: {name: 'Combo Empanada+Bebida', price: 6500}
  };

  // 2. RENDERIZADO EN PANTALLA
  const listItems = document.getElementById('list-items');
  const listCombos = document.getElementById('list-combos');

  function renderRow(id, item, container) {
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `
      <label>${item.name} ($${item.price})</label>
      <input type="number" min="0" class="qty-input" data-id="${id}" placeholder="0">
    `;
    container.appendChild(div);
  }

  Object.entries(products).forEach(([k, v]) => {
    // Separar visualmente por ID (i = individual, c = combo)
    if(k.startsWith('i')) renderRow(k, v, listItems);
    else renderRow(k, v, listCombos);
  });

  // 3. C√ÅLCULOS
  function calculate() {
    let total = 0;
    let items = [];
    
    document.querySelectorAll('.qty-input').forEach(input => {
      const val = parseInt(input.value) || 0;
      if(val > 0) {
        const pid = input.dataset.id;
        const prod = products[pid];
        const subtotal = val * prod.price;
        total += subtotal;
        items.push({ ...prod, qty: val, subtotal });
      }
    });

    // Vuelto
    const received = parseInt(document.getElementById('received').value) || 0;
    const vuelto = received - total;

    return { total, items, received, vuelto };
  }

  function updateUI() {
    const data = calculate();
    document.getElementById('display-total').innerText = `Total: $${data.total.toLocaleString('es-CL')}`;
    
    const vueltoEl = document.getElementById('display-vuelto');
    if(data.received > 0) {
      vueltoEl.innerText = data.vuelto >= 0 
        ? `Vuelto: $${data.vuelto.toLocaleString('es-CL')}` 
        : `Falta: $${Math.abs(data.vuelto).toLocaleString('es-CL')}`;
      vueltoEl.style.color = data.vuelto >= 0 ? '#28a745' : '#dc3545';
    } else {
      vueltoEl.innerText = "Vuelto: $0";
    }

    // Preview texto
    const preview = document.getElementById('preview-text');
    if(data.items.length === 0) preview.innerText = "Sin √≠tems...";
    else {
      preview.innerHTML = data.items.map(i => `<div>${i.qty} x ${i.name}</div>`).join('');
    }
  }

  // Listeners
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', updateUI));

  // 4. GENERACI√ìN PDF (ESTRATEGIA TABLA + FONDO BLANCO)
  document.getElementById('btn-print').addEventListener('click', async () => {
    const data = calculate();
    if(data.items.length === 0) return alert("Agrega productos primero");

    const btn = document.getElementById('btn-print');
    btn.disabled = true;
    btn.innerText = "Generando...";

    const now = new Date();
    const fecha = now.toLocaleDateString('es-CL');
    const hora = now.toLocaleTimeString('es-CL');
    const cliente = document.getElementById('clientName').value || "Cliente General";

    // CREAMOS EL HTML DEL PDF USANDO TABLAS (M√°s robusto para html2pdf)
    // Definimos estilos INLINE expl√≠citos (color: black, background: white)
    const itemRows = data.items.map(item => `
      <tr>
        <td style="padding: 4px 0; border-bottom: 1px dotted #ccc;">${item.qty} x ${item.name}</td>
        <td style="padding: 4px 0; border-bottom: 1px dotted #ccc; text-align: right;">$${item.subtotal.toLocaleString('es-CL')}</td>
      </tr>
    `).join('');

    const content = `
      <div style="width: 270px; padding: 10px; background-color: #ffffff; color: #000000; font-family: Helvetica, sans-serif; border: 1px solid white;">
        
        <div style="text-align: center; margin-bottom: 15px;">
          <h2 style="margin: 0; font-size: 18px;">‚òï CAF√â CONCERT</h2>
          <p style="margin: 2px 0; font-size: 12px;">COMPROBANTE</p>
          <p style="margin: 2px 0; font-size: 12px;">${fecha} - ${hora}</p>
        </div>

        <div style="margin-bottom: 10px; font-size: 12px;">
          <strong>Cliente:</strong> ${cliente}
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px;">
          ${itemRows}
        </table>

        <div style="border-top: 2px solid #000; margin-top: 10px; padding-top: 5px;">
          <table style="width: 100%; font-size: 14px; font-weight: bold;">
            <tr>
              <td>TOTAL</td>
              <td style="text-align: right;">$${data.total.toLocaleString('es-CL')}</td>
            </tr>
          </table>
        </div>

        ${data.received > 0 ? `
          <div style="margin-top: 5px; font-size: 12px;">
            <table style="width: 100%;">
              <tr><td>Efectivo:</td><td style="text-align: right;">$${data.received.toLocaleString('es-CL')}</td></tr>
              <tr><td>Vuelto:</td><td style="text-align: right;">$${data.vuelto.toLocaleString('es-CL')}</td></tr>
            </table>
          </div>
        ` : ''}
        
        <div style="text-align: center; margin-top: 20px; font-size: 10px; color: #444;">
          <p>Gracias por su preferencia</p>
        </div>
      </div>
    `;

    // ELEMENTO TEMPORAL
    // Lo agregamos al body para asegurar que el navegador lo renderice
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = content;
    // Estilos para que no moleste al usuario pero s√≠ sea "visible" para la librer√≠a
    tempDiv.style.position = 'absolute';
    tempDiv.style.top = '0';
    tempDiv.style.left = '0';
    tempDiv.style.zIndex = '-9999'; // Detr√°s de todo
    tempDiv.style.background = '#ffffff'; // Fondo blanco expl√≠cito
    
    document.body.appendChild(tempDiv);

    const opt = {
      margin:       1,
      filename:     `Pedido_${now.getTime()}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, logging: false }, // Escala mejora calidad texto
      jsPDF:        { unit: 'mm', format: [80, 200], orientation: 'portrait' } // Formato Ticket
    };

    try {
      // Esperamos un momento para que el navegador pinte el elemento temporal
      await new Promise(r => setTimeout(r, 200));
      await html2pdf().set(opt).from(tempDiv).save();
    } catch (error) {
      console.error(error);
      alert("Error al crear PDF");
    } finally {
      // Limpieza
      if (document.body.contains(tempDiv)) {
        document.body.removeChild(tempDiv);
      }
      btn.disabled = false;
      btn.innerText = "üìÑ DESCARGAR PDF";
    }
  });
</script>
</body>
</html>